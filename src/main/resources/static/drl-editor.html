<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DRL 规则编辑器</title>
  <script src="/lib/js/vue.js"></script>
  <script src="/lib/js/tw.js"></script>
  <style>
    /* 代码高亮样式 - 浅色主题 */
    .syntax-keyword { color: #7c3aed; font-weight: bold; }
    .syntax-string { color: #059669; }
    .syntax-comment { color: #6b7280; font-style: italic; }
    .syntax-rule-name { color: #dc2626; font-weight: bold; }
    .syntax-operator { color: #2563eb; }

    /* 滚动条样式 - 浅色 */
    #codePreview::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    #codePreview::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    #codePreview::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    #codePreview::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="bg-gradient-to-br from-slate-50 via-blue-50 to-slate-50 min-h-screen p-4">
      <div class="max-w-7xl mx-auto space-y-4">
        <!-- 标题 -->
        <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-sm p-4 border border-slate-200">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0">
            <div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-sky-600 to-indigo-600 bg-clip-text text-transparent">DRL 规则编辑器</h1>
              <p class="text-sm text-gray-600">可视化生成 Drools 规则文件</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button @click="loadSample" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all font-medium text-sm shadow-sm hover:shadow">
                加载示例
              </button>
              <button @click="downloadDRL" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-all font-medium text-sm shadow-sm hover:shadow">
                下载 DRL 文件
              </button>
              <button @click="copyCode" :class="['px-4 py-2 text-white rounded-lg transition-all font-medium text-sm shadow-sm hover:shadow', copyButtonText === '已复制！' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-sky-500 hover:bg-sky-600']">
                {{ copyButtonText }}
              </button>
              <a href="/" class="px-4 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600 transition-all font-medium text-sm shadow-sm hover:shadow">
                返回首页
              </a>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- 左侧：规则配置表单 -->
          <div class="space-y-4">
            <!-- 全局配置 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-sm p-4 border border-slate-200">
              <h2 class="text-lg font-semibold text-gray-700 mb-3">全局配置</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">包名 (package)</label>
                  <input v-model="config.package" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-400 focus:border-sky-400 transition">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Unit 名称 (可选)</label>
                  <input v-model="config.unit" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-400 focus:border-sky-400 transition" placeholder="例如: PersonRules">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">导入语句 (每行一个)</label>
                  <textarea v-model="config.imports" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-400 focus:border-sky-400 transition font-mono text-sm" placeholder="例如:&#10;import com.example.droolsdemo.model.Person;&#10;import com.example.droolsdemo.util.RuleUtils;&#10;import java.util.List;"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">全局变量 (每行一个)</label>
                  <textarea v-model="config.globals" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-400 focus:border-sky-400 transition font-mono text-sm" placeholder="例如:&#10;global org.slf4j.Logger logger;&#10;global java.util.Map dataMap;"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">声明类型 (declare, 可选)</label>
                  <textarea v-model="config.declarations" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-400 focus:border-sky-400 transition font-mono text-sm" placeholder="例如:&#10;declare Animal&#10;    name: String&#10;    age: int&#10;end"></textarea>
                </div>
              </div>
            </div>

            <!-- 规则列表 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-sm p-4 border border-slate-200">
              <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold text-gray-700">规则列表</h2>
                <button @click="addRule" class="px-3 py-1 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600 transition-all shadow-sm hover:shadow font-medium">
                  + 添加规则
                </button>
              </div>
              <div class="space-y-3">
                <div v-for="(rule, index) in rules" :key="index" class="border border-slate-200 rounded-lg p-4 bg-gradient-to-br from-white to-slate-50 shadow-sm hover:shadow-md transition-all">
                  <div class="flex justify-between items-center mb-2">
                    <input v-model="rule.name" type="text" class="flex-1 px-2 py-1 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
                    <button @click="removeRule(index)" class="ml-2 px-2 py-1 bg-rose-400 text-white text-xs rounded-lg hover:bg-rose-500 transition-all shadow-sm">删除</button>
                  </div>
                  <div class="space-y-2">
                    <div class="grid grid-cols-3 gap-2 text-xs">
                      <label class="flex items-center">
                        <input v-model="rule.enabled" type="checkbox" class="mr-1">
                        <span>启用</span>
                      </label>
                      <label class="flex items-center">
                        <input v-model="rule.noLoop" type="checkbox" class="mr-1">
                        <span>No-Loop</span>
                      </label>
                      <label class="flex items-center">
                        <input v-model="rule.lockOnActive" type="checkbox" class="mr-1">
                        <span>Lock-Active</span>
                      </label>
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">优先级 (salience)</label>
                      <input v-model.number="rule.salience" type="number" class="w-full px-2 py-1 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">When 条件</label>
                      <textarea v-model="rule.when" rows="2" class="w-full px-2 py-1 border border-slate-300 rounded-md text-sm font-mono focus:ring-2 focus:ring-sky-400 focus:border-sky-400"></textarea>
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Then 动作</label>
                      <textarea v-model="rule.then" rows="3" class="w-full px-2 py-1 border border-slate-300 rounded-md text-sm font-mono focus:ring-2 focus:ring-sky-400 focus:border-sky-400"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 右侧：代码预览和帮助 -->
          <div class="space-y-4">
            <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-sm p-4 border border-slate-200">
              <h2 class="text-lg font-semibold text-gray-700 mb-3">DRL 代码预览</h2>
              <pre id="codePreview" class="bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-300 text-slate-800 p-4 rounded overflow-x-auto text-sm font-mono min-h-[400px] max-h-[600px] shadow-inner">{{ generateDRL() }}</pre>
            </div>

            <!-- 帮助说明 -->
            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                <div class="text-sm text-blue-800">
                  <p class="font-semibold mb-1">使用提示：</p>
                  <ul class="list-disc list-inside space-y-1 text-xs">
                    <li><strong>包名 (Package):</strong> 定义规则所属的包</li>
                    <li><strong>Unit 名称:</strong> 单元名称，用于规则组织</li>
                    <li><strong>导入 (Import):</strong> 导入需要的Java类</li>
                    <li><strong>全局变量 (Global):</strong> 定义全局对象，如logger</li>
                    <li><strong>Salience:</strong> 规则优先级，数值越大越先执行</li>
                    <li><strong>No-Loop:</strong> 防止规则循环触发</li>
                    <li><strong>When:</strong> 规则条件（LHS - Left Hand Side）</li>
                    <li><strong>Then:</strong> 规则动作（RHS - Right Hand Side）</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          config: {
            package: 'com.example.rules',
            unit: '',
            imports: '',
            globals: '',
            declarations: ''
          },
          rules: [],
          copyButtonText: '复制代码'
        };
      },
      mounted() {
        // 初始化：添加第一个规则
        this.addRule();
        // 或者加载示例
        // this.loadSample();
      },
      methods: {
        addRule() {
          this.rules.push({
            name: 'rule_' + Date.now(),
            enabled: true,
            salience: 10,
            noLoop: false,
            lockOnActive: false,
            when: '',
            then: ''
          });
        },
        removeRule(index) {
          this.rules.splice(index, 1);
        },
        loadSample() {
          // 设置全局配置
          this.config = {
            package: 'com.example.rules',
            unit: 'PersonRules',
            imports: 'import com.example.droolsdemo.model.Person;\nimport com.example.droolsdemo.util.RuleUtils;',
            globals: 'global org.slf4j.Logger logger;',
            declarations: ''
          };

          // 设置规则示例
          this.rules = [
            {
              name: 'CheckAdult',
              enabled: true,
              salience: 10,
              noLoop: true,
              lockOnActive: false,
              when: '    $p: Person($age: age >= 18)',
              then: '    $p.setAdult(true);\n    logger.info("{} 已成年",$p.getName());\n    update($p);'
            },
            {
              name: 'CheckSex',
              enabled: true,
              salience: 15,
              noLoop: false,
              lockOnActive: false,
              when: '    $p : Person(sex == "girl")',
              then: '    logger.warn("{} 是一个女孩", $p.getName());\n    $p.setSex("boy");\n    update($p);'
            }
          ];
        },
        generateDRL() {
          const pkg = this.config.package || 'com.example.rules';
          const unit = this.config.unit;
          const imports = this.config.imports.split('\n').filter(line => line.trim());
          const globals = this.config.globals.split('\n').filter(line => line.trim());
          const declarations = this.config.declarations;

          let code = `package ${pkg};\n\n`;

          if (unit) {
            code += `unit ${unit};\n\n`;
          }

          if (imports.length > 0) {
            imports.forEach(imp => {
              code += `${imp.trim()}\n`;
            });
            code += `\n`;
          }

          if (declarations) {
            code += `${declarations}\n\n`;
          }

          if (globals.length > 0) {
            globals.forEach(g => {
              code += `global ${g.trim()}\n`;
            });
            code += `\n`;
          }

          this.rules.forEach(rule => {
            code += `rule "${rule.name}"\n`;
            if (rule.enabled !== undefined) {
              code += `    enabled ${rule.enabled}\n`;
            }
            if (rule.salience !== undefined) {
              code += `    salience ${rule.salience}\n`;
            }
            if (rule.noLoop) {
              code += `    no-loop true\n`;
            }
            if (rule.lockOnActive) {
              code += `    lock-on-active true\n`;
            }
            code += `when\n`;
            if (rule.when) {
              code += `${rule.when}\n`;
            }
            code += `then\n`;
            if (rule.then) {
              const thenLines = rule.then.split('\n');
              thenLines.forEach(line => {
                code += `${line}\n`;
              });
            }
            code += `end\n\n`;
          });

          return code;
        },
        downloadDRL() {
          const code = this.generateDRL();
          const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `rules-${Date.now()}.drl`;
          a.click();
          URL.revokeObjectURL(url);
        },
        async copyCode() {
          const code = this.generateDRL();
          try {
            await navigator.clipboard.writeText(code);
            this.copyButtonText = '已复制！';
            setTimeout(() => {
              this.copyButtonText = '复制代码';
            }, 2000);
          } catch (err) {
            alert('复制失败: ' + err);
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
